# FlagPilot Backend v6.1 (Smart-Stack Edition)

## Enterprise-Grade Multi-Agent Architecture

AI-powered freelancer protection backend using **LangGraph** for multi-agent orchestration with **CopilotKit** for frontend integration.

---

## âœ¨ What's New in v6.1

| Feature | Description |
|---------|-------------|
| **AsyncPostgresSaver** | Async-compatible checkpointer for CopilotKit streaming |
| **LLM Router** | Semantic agent selection replacing keyword matching |
| **PostgresStore** | Cross-thread long-term memory for user preferences |
| **17 Agents** | Expanded from 14 specialized protection agents |
| **Fast-Fail Detection** | Programmatic scam signal detection before LLM calls |

---

## ğŸ—ï¸ Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        FLAGPILOT BACKEND v6.1                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          API LAYER (FastAPI)                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ /copilotkit  â”‚  â”‚ /api/agents  â”‚  â”‚ /api/memory  â”‚  â”‚ /api/v1/rag  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  AG-UI SSE   â”‚  â”‚  List/Get    â”‚  â”‚ Wisdom/Prof  â”‚  â”‚   Ingest     â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                           â”‚
â”‚                                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                            LLM ROUTER                                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚    Semantic     â”‚  â”‚   Confidence    â”‚  â”‚       Urgency Level         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    Task         â”‚  â”‚     Scoring     â”‚  â”‚       Detection             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    Analysis     â”‚  â”‚   per Agent     â”‚  â”‚  low / medium / high / crit â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                              â”‚                                             â”‚  â”‚
â”‚  â”‚                              â–¼                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚              agent_ids: [contract-guardian, job-authenticator]       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚              confidence: 0.87  |  urgency: high                      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                           â”‚
â”‚                                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      LANGGRAPH ORCHESTRATOR                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚                â”‚   â”‚                â”‚   â”‚                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚   PLAN NODE    â”‚â”€â”€â–¶â”‚ EXECUTE AGENTS â”‚â”€â”€â–¶â”‚      SYNTHESIZE NODE       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                â”‚   â”‚   (Parallel)   â”‚   â”‚                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Fast-fail    â”‚   â”‚                â”‚   â”‚ â€¢ Combine agent outputs    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Agent select â”‚   â”‚ â€¢ Run selected â”‚   â”‚ â€¢ Generate final response  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Context prep â”‚   â”‚ â€¢ Collect data â”‚   â”‚ â€¢ Risk level synthesis     â”‚ â”‚  â”‚
â”‚  â”‚  â”‚                â”‚   â”‚                â”‚   â”‚                            â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                              â”‚                                             â”‚  â”‚
â”‚  â”‚                              â–¼                                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚                    17 SPECIALIST AGENTS                              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ âš–ï¸ Contract â”‚ â”‚ ğŸ” Job      â”‚ â”‚ ğŸš¨ Risk     â”‚ â”‚ ğŸ¯ Scope    â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Guardian   â”‚ â”‚  Authent.   â”‚ â”‚  Advisor    â”‚ â”‚  Sentinel   â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Legal      â”‚ â”‚  Scam Det.  â”‚ â”‚  Fast-Fail  â”‚ â”‚  Creep Det. â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ’° Payment  â”‚ â”‚ ğŸ¤ Negot.   â”‚ â”‚ ğŸ’¬ Comms    â”‚ â”‚ âš”ï¸ Dispute  â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Enforcer   â”‚ â”‚  Assistant  â”‚ â”‚  Coach      â”‚ â”‚  Mediator   â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Collection â”‚ â”‚  Rate/Value â”‚ â”‚  Messaging  â”‚ â”‚  Resolution â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ‘» Ghosting â”‚ â”‚ ğŸ“Š Profile  â”‚ â”‚ ğŸ“ Talent   â”‚ â”‚ ğŸ“ App      â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Shield     â”‚ â”‚  Analyzer   â”‚ â”‚  Vet        â”‚ â”‚  Filter     â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Re-engage  â”‚ â”‚  Client Vet â”‚ â”‚  Evaluate   â”‚ â”‚  Screen     â”‚    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ”„ Feedback â”‚ â”‚ ğŸ“‹ Planner  â”‚ â”‚    + 3 Additional Agents      â”‚  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Loop       â”‚ â”‚  Role       â”‚ â”‚                               â”‚  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Learning   â”‚ â”‚  Organize   â”‚ â”‚                               â”‚  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚                                                                       â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                           â”‚
â”‚                                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       PERSISTENCE LAYER                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚      PostgreSQL      â”‚  â”‚    Elasticsearch     â”‚  â”‚      Redis      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ AsyncPostgres  â”‚  â”‚  â”‚  â”‚ Global Wisdom  â”‚  â”‚  â”‚  â”‚ Session   â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Saver          â”‚  â”‚  â”‚  â”‚ (5-star tips)  â”‚  â”‚  â”‚  â”‚ Cache     â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ PostgresStore  â”‚  â”‚  â”‚  â”‚ User Profiles  â”‚  â”‚  â”‚  â”‚ Rate      â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ (Long-term)    â”‚  â”‚  â”‚  â”‚ (preferences)  â”‚  â”‚  â”‚  â”‚ Limiting  â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â”‚           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ User Auth      â”‚  â”‚  â”‚  â”‚ Chat History   â”‚  â”‚  â”‚  â”‚           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ (Drizzle)      â”‚  â”‚  â”‚  â”‚ (searchable)   â”‚  â”‚  â”‚  â”‚           â”‚  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                      â”‚  â”‚  â”‚ Experience     â”‚  â”‚  â”‚                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                      â”‚  â”‚  â”‚ Gallery        â”‚  â”‚  â”‚                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                      â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                 â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚                                           â”‚
â”‚                                      â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                       EXTERNAL SERVICES                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚       RAGFlow        â”‚  â”‚      OpenRouter      â”‚  â”‚    LangSmith    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Document Upload     â”‚  â”‚  LLM API Gateway     â”‚  â”‚  Tracing        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Semantic Search     â”‚  â”‚  Claude/GPT-4/etc    â”‚  â”‚  Evaluation     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Knowledge Base      â”‚  â”‚  Rate Limiting       â”‚  â”‚  Debugging      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Directory Structure

```
backend/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ agents.py              # Agent registry (17 agents)
â”‚   â”œâ”€â”€ orchestrator.py        # LangGraph orchestrator
â”‚   â”œâ”€â”€ router.py              # LLM-based agent selection (NEW)
â”‚   â””â”€â”€ roles/                 # Individual agent definitions
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ copilotkit/
â”‚   â”‚   â”œâ”€â”€ graph.py           # LangGraph workflow definition
â”‚   â”‚   â””â”€â”€ sdk.py             # CopilotKit endpoint handler
â”‚   â”œâ”€â”€ persistence/           # (NEW in v6.1)
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ checkpointer.py    # AsyncPostgresSaver factory
â”‚   â”‚   â””â”€â”€ long_term_memory.py # PostgresStore wrapper
â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â””â”€â”€ manager.py         # Elasticsearch memory operations
â”‚   â””â”€â”€ tools/
â”‚       â””â”€â”€ rag_tool.py        # RAGFlow search utility
â”‚
â”œâ”€â”€ ragflow/
â”‚   â””â”€â”€ client.py              # RAGFlow SDK wrapper
â”‚
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ agents.py              # /api/agents endpoints
â”‚   â”œâ”€â”€ health.py              # /health endpoint
â”‚   â”œâ”€â”€ rag.py                 # /api/v1/rag endpoints
â”‚   â””â”€â”€ memory.py              # /api/memory endpoints
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_live_system.py    # Full integration tests
â”‚   â””â”€â”€ test_smart_stack.py    # Smart-Stack feature tests
â”‚
â”œâ”€â”€ config.py                  # Pydantic settings + LangSmith
â”œâ”€â”€ main.py                    # FastAPI application
â”œâ”€â”€ run.py                     # Entry point
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ .env.example               # Environment template
â””â”€â”€ requirements-core.txt
```

---

## ğŸ”§ Technology Stack

| Layer | Component | Technology |
|-------|-----------|------------|
| **API** | Web Framework | FastAPI |
| **Agents** | Orchestration | LangGraph |
| **Agents** | LLM Integration | LangChain |
| **Routing** | Task Analysis | LLM Router (OpenRouter) |
| **State** | Checkpointing | AsyncPostgresSaver |
| **Memory** | Long-term | PostgresStore |
| **Memory** | Searchable | Elasticsearch 9.0 |
| **Cache** | Sessions | Redis |
| **Knowledge** | RAG | RAGFlow |
| **LLM** | Provider | OpenRouter (multi-model) |
| **Observability** | Tracing | LangSmith |
| **Container** | Runtime | Docker |

---

## âš™ï¸ Environment Variables

### Required

```env
OPENROUTER_API_KEY=sk-or-v1-your-key
OPENROUTER_MODEL=kwaipilot/kat-coder-pro:free
```

### Database (Recommended)

```env
DATABASE_URL=postgresql://postgres:postgres@postgres:5432/flagpilot
REDIS_URL=redis://:password@redis:6379
ES_HOST=es01
ES_PORT=9200
```

### Observability (Optional)

```env
LANGSMITH_API_KEY=lsv2_pt_your-key
LANGSMITH_PROJECT=flagpilot
```

### RAG (Optional)

```env
RAGFLOW_URL=http://ragflow:80
RAGFLOW_API_KEY=your-key
```

---

## ğŸš€ Quick Start

```bash
# With docker-compose
docker-compose up -d backend

# Or standalone
docker build -t flagpilot-backend .
docker run -p 8000:8000 --env-file .env flagpilot-backend

# Run tests
docker exec Flagpilot-backend python tests/test_smart_stack.py
```

---

## ğŸ“¡ API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/` | GET | Service info |
| `/health` | GET | Health check with features |
| `/copilotkit` | POST | CopilotKit AG-UI endpoint |
| `/api/agents` | GET | List all agents (17) |
| `/api/agents/{id}` | GET | Get agent details |
| `/api/memory/wisdom` | GET | Get global wisdom |
| `/api/memory/profile/{user_id}` | GET | Get user profile |
| `/api/memory/sessions/{user_id}` | GET | Get recent sessions |
| `/api/v1/rag/ingest` | POST | Ingest document |

---

## ğŸ¤– Agent Capabilities

| Agent ID | Specialization | Credit Cost |
|----------|----------------|-------------|
| `contract-guardian` | Legal contract analysis | 1 |
| `job-authenticator` | Scam detection (Fast-Fail) | 1 |
| `risk-advisor` | Critical risk protocols | 2 |
| `scope-sentinel` | Scope creep detection | 1 |
| `payment-enforcer` | Invoice collection | 1 |
| `negotiation-assistant` | Rate negotiation | 1 |
| `communication-coach` | Message drafting | 1 |
| `dispute-mediator` | Conflict resolution | 1 |
| `ghosting-shield` | Client recovery | 1 |
| `profile-analyzer` | Client vetting | 1 |
| `talent-vet` | Candidate evaluation | 1 |
| `application-filter` | Application screening | 1 |
| `feedback-loop` | Outcome learning | 0 |
| `planner-role` | Task planning | 1 |

---

## ğŸ“Š Version History

| Version | Date | Changes |
|---------|------|---------|
| **v6.1.0** | Dec 2024 | AsyncPostgresSaver, LLM Router, 17 agents |
| **v6.0.0** | Dec 2024 | LangGraph migration, LangSmith observability |
| **v5.x** | Nov 2024 | MetaGPT architecture (deprecated) |
