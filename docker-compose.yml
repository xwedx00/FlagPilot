# FlagPilot Docker Compose
# ========================
# Services: Backend + Redis + RAGFlow Stack + PostgreSQL
# Full stack with all dependencies

services:
  # ===========================================
  # Backend - FastAPI + MetaGPT
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: Flagpilot-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PYTHONPATH=/app
      - GIT_PYTHON_REFRESH=quiet
      # Redis
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      # OpenRouter LLM
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL}
      - OPENROUTER_BASE_URL=https://openrouter.ai/api/v1
      # RAGFlow
      - RAGFLOW_URL=http://ragflow:80
      - RAGFLOW_API_KEY=${RAGFLOW_API_KEY:-}
      # Database URL (used by frontend, exposed here for consistency)
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-Flagpilot}
    volumes:
      - ./backend:/app
      - backend_logs:/app/logs
    depends_on:
      redis:
        condition: service_healthy
      ragflow:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # Redis (Latest - Shared by Backend + RAGFlow)
  # ===========================================
  redis:
    image: redis:latest
    container_name: Flagpilot-redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # RAGFlow Stack (Latest Versions)
  # ===========================================

  # 1. ElasticSearch 9.0.2 (Vector Store + FlagPilot Memory System)
  # Used by: RAGFlow (embeddings) AND FlagPilot (profiles, chat, wisdom)
  es01:
    container_name: ragflow-es01
    image: docker.elastic.co/elasticsearch/elasticsearch:${STACK_VERSION:-9.0.2}
    restart: unless-stopped
    environment:
      - node.name=es01
      - cluster.name=ragflow-cluster
      - discovery.type=single-node
      - "ES_JAVA_OPTS=${ES_JAVA_OPTS:--Xms1g -Xmx1g}"
      - bootstrap.memory_lock=true
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "127.0.0.1:${ES_PORT:-9200}:9200"
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'green\\|yellow'" ]
      interval: 30s
      timeout: 10s
      retries: 50
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: ${MEM_LIMIT:-8g}

  # 2. MinIO (Latest - Object Storage)
  minio:
    container_name: ragflow-minio
    image: quay.io/minio/minio:latest
    restart: unless-stopped
    command: server --console-address ":9001" /data
    ports:
      - "127.0.0.1:${MINIO_PORT:-9000}:9000"
      - "127.0.0.1:${MINIO_CONSOLE_PORT:-9001}:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD:-minioadmin}
    volumes:
      - minio_data:/data
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD", "mc", "ready", "local" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # 3. MySQL 8.0 - RAGFlow Internal Database
  # NOTE: This is ONLY used by RAGFlow for its internal metadata.
  # FlagPilot does NOT use MySQL - it uses Elasticsearch for memory.
  mysql:
    container_name: ragflow-mysql
    image: mysql:8.0
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER:-rag_flow}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=rag_flow
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "127.0.0.1:${MYSQL_PORT:-5455}:3306"
    command: >
      --max_connections=1000 --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci --default-authentication-plugin=mysql_native_password --transaction-isolation=READ-COMMITTED
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "--silent" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G

  # 4. RAGFlow Server (Latest v0.22.1)
  ragflow:
    container_name: ragflow-server
    image: ${RAGFLOW_IMAGE:-infiniflow/ragflow:v0.22.1}
    restart: unless-stopped
    depends_on:
      es01:
        condition: service_healthy
      minio:
        condition: service_started
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "127.0.0.1:${SVR_HTTP_PORT:-9380}:80"
      - "127.0.0.1:9381:9381"
    environment:
      # MySQL Configuration (per RAGFlow docs)
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=${MYSQL_USER:-rag_flow}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      # Elasticsearch
      - ES_HOST=es01
      # MinIO (per RAGFlow docs)
      - MINIO_HOST=minio:9000
      - MINIO_USER=${MINIO_USER:-minioadmin}
      - MINIO_PASSWORD=${MINIO_PASSWORD:-minioadmin}
      # Redis (per RAGFlow docs - critical for real-time features)
      - REDIS_HOST=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # RAGFlow Settings
      - SVR_HTTP_PORT=${SVR_HTTP_PORT:-9380}
      - REGISTER_ENABLED=${REGISTER_ENABLED:-1}
      # Timezone
      - TZ=${TZ:-UTC}
      # OpenRouter
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL}
      - OPENROUTER_BASE_URL=${OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
    volumes:
      - ./service_conf.yaml.template:/ragflow/conf/service_conf.yaml.template
      - ./nginx-ragflow.conf:/etc/nginx/sites-enabled/default
      - ragflow_logs:/ragflow/logs
      - ragflow_data:/ragflow/data
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --spider http://localhost:80/ || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s

  # ===========================================
  # 5. PostgreSQL (Auth/Users/Billing)
  # ===========================================
  postgres:
    image: postgres:latest
    container_name: Flagpilot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-Flagpilot}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - Flagpilot-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  redis_data:
    name: Flagpilot_redis_data
  es_data:
    name: ragflow_es_data
  minio_data:
    name: ragflow_minio_data
  mysql_data:
    name: ragflow_mysql_data
  postgres_data:
    name: Flagpilot_postgres_data
  ragflow_logs:
    name: ragflow_logs
  ragflow_data:
    name: ragflow_data
  backend_logs:
    name: Flagpilot_backend_logs

# ===========================================
# Network
# ===========================================
networks:
  Flagpilot-network:
    name: Flagpilot-network
    driver: bridge
